name: Safe MERN Deployment

on:
  push:
    branches:
      - main

jobs:
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Install Backend Dependencies
      working-directory: ./backend
      run: npm install

    - name: Install Frontend Dependencies
      working-directory: ./frontend
      run: npm install

    - name: Build Frontend
      working-directory: ./frontend
      run: npm run build

    - name: Check Frontend Build Output
      run: |
        if [ ! -f frontend/dist/index.html ]; then
          echo "âŒ Frontend build failed"
          exit 1
        else
          echo "âœ… Frontend build succeeded"
        fi

  cd:
    name: Continuous Deployment
    needs: ci
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Deploy to Ubuntu Server via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        timeout: 30s
        command_timeout: 10m
        script: |
          echo "ğŸ“ Step 1: Create temp folder and clone"
          rm -rf /home/hostapp/temp_mern_deploy
          git clone https://github.com/React-Testing/React-02.git /home/hostapp/temp_mern_deploy

          echo "ğŸ“¦ Step 2: Install and run backend temporarily"
          cd /home/hostapp/temp_mern_deploy/backend
          npm install
          PORT=5001 pm2 start server.js --name temp-mern-backend --env production
          sleep 5

          echo "ğŸ” Step 3: Check if backend is running"
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5001/api/test)
          if [ "$BACKEND_STATUS" -ge 200 ] && [ "$BACKEND_STATUS" -lt 400 ]; then
            echo "âœ… Backend is running fine (HTTP $BACKEND_STATUS)"
          else
            echo "âŒ Backend check failed with code $BACKEND_STATUS"
            pm2 delete temp-mern-backend
            exit 1
          fi

          echo "ğŸ›  Step 4: Build frontend"
          cd /home/hostapp/temp_mern_deploy/frontend
          npm install
          npm run build

          if [ ! -f dist/index.html ]; then
            echo "âŒ Frontend build failed"
            pm2 delete temp-mern-backend
            exit 1
          fi

          echo "ğŸ—‚ Step 5: Backup current project"
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          mv /home/hostapp/React-02 /home/hostapp/backup_React-02_$TIMESTAMP

          echo "ğŸ“‚ Step 6: Deploy new code"
          mv /home/hostapp/temp_mern_deploy /home/hostapp/React-02

          echo "ğŸ”¥ Step 7: Restart backend"
          pm2 delete temp-mern-backend
          cd /home/hostapp/React-02/backend
          pm2 start server.js --name mern-backend

          echo "ğŸŒ Step 8: Deploy frontend to Nginx root"
          sudo rm -rf /opt/day07/*
          sudo cp -r /home/hostapp/React-02/frontend/dist/* /opt/day07/

          echo "ğŸ” Step 9: Restart Nginx"
          sudo nginx -t
          sudo systemctl restart nginx

          echo "âœ… CI/CD Deployment Completed Successfully!"
